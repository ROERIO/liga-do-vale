<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIGA DO VALE - Sua cidade em um s√≥ lugar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f3f4f6; }
        .slide-in { animation: slideIn 0.3s ease-in; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; }
        .loading.show { display: flex; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 10px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <!-- MODAL TERMOS -->
    <div id="termsModal" class="modal">
        <div class="modal-content slide-in">
            <h1 style="color:#16a34a;font-size:26px;margin-bottom:20px;font-weight:bold;">‚öñÔ∏è TERMOS DE USO E POL√çTICA DE PRIVACIDADE</h1>
            <h2 style="color:#333;font-size:18px;margin-bottom:20px;">LIGA DO VALE</h2>
            <div style="background:#fef3c7;padding:15px;border-left:4px solid #f59e0b;margin:20px 0;border-radius:5px;">
                <strong>‚ö†Ô∏è IMPORTANTE:</strong> Ao utilizar a LIGA DO VALE, voc√™ concorda com as seguintes regras:
            </div>
            <h2 style="color:#333;font-size:18px;margin-top:25px;margin-bottom:12px;">1. O QUE N√ìS FAZEMOS</h2>
            <p style="color:#444;margin-bottom:12px;line-height:1.8;">A LIGA DO VALE √© uma plataforma de conex√£o hiperlocal. Facilitamos o acesso a informa√ß√µes (empregos, eventos, ofertas) e o contato entre pessoas. <strong>N√£o somos respons√°veis pelas negocia√ß√µes, qualidade dos servi√ßos ou veracidade dos an√∫ncios postados por usu√°rios.</strong></p>
            <h2 style="color:#333;font-size:18px;margin-top:25px;margin-bottom:12px;">2. SEUS DADOS E PRIVACIDADE</h2>
            <p style="color:#444;margin-bottom:12px;line-height:1.8;">Coletamos seu <strong>Nome</strong> e <strong>N√∫mero de WhatsApp</strong>. Ao postar an√∫ncio, seu nome e telefone ficar√£o vis√≠veis. <strong>N√£o vendemos seus dados.</strong></p>
            <h2 style="color:#333;font-size:18px;margin-top:25px;margin-bottom:12px;">3. REGRAS DE CONDUTA</h2>
            <p style="color:#444;margin-bottom:8px;">√â proibido postar:</p>
            <ul style="margin-left:25px;margin-bottom:15px;line-height:1.8;color:#444;">
                <li>Conte√∫do ilegal, ofensivo ou pornogr√°fico</li>
                <li>An√∫ncios falsos ou golpes</li>
                <li>Ass√©dio a outros usu√°rios</li>
            </ul>
            <div style="background:#fef3c7;padding:15px;border-left:4px solid #f59e0b;margin:20px 0;border-radius:5px;">
                <strong>‚ö†Ô∏è PUNI√á√ÉO:</strong> Banimento imediato sem reembolso.
            </div>
            <h2 style="color:#333;font-size:18px;margin-top:25px;margin-bottom:12px;">4. PAGAMENTOS</h2>
            <ul style="margin-left:25px;margin-bottom:15px;line-height:1.8;color:#444;">
                <li>Teste gratuito at√© <strong>1¬∫ de abril de 2026</strong></li>
                <li>Plano Semanal: <strong>R$ 1,99/semana</strong></li>
                <li>Plano Mensal: <strong>R$ 4,99/m√™s</strong></li>
            </ul>
            <h2 style="color:#333;font-size:18px;margin-top:25px;margin-bottom:12px;">5. TRANSA√á√ïES ENTRE USU√ÅRIOS</h2>
            <p style="color:#444;margin-bottom:12px;line-height:1.8;">A LIGA DO VALE <strong>n√£o processa pagamentos</strong> de produtos vendidos entre usu√°rios.</p>
            <div style="background:#fef3c7;padding:15px;border-left:4px solid #f59e0b;margin:20px 0;border-radius:5px;">
                <strong>üí° DICA:</strong> Nunca pague adiantado por algo que n√£o viu pessoalmente.
            </div>
            <hr style="margin:30px 0;border:none;border-top:1px solid #ddd;">
            <p style="font-size:13px;color:#666;text-align:center;margin-bottom:20px;">
                <strong>LIGA DO VALE</strong> - √öltima atualiza√ß√£o: 16 de fevereiro de 2026
            </p>
            <center>
                <button onclick="closeTermsModal()" style="background:#16a34a;color:white;padding:12px 25px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;font-size:14px;">‚úÖ ENTENDI E ACEITO</button>
            </center>
        </div>
    </div>

    <!-- SUPABASE CDN - CARREGA PRIMEIRO -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <script>
        // AGUARDA O SUPABASE CARREGAR
        const SUPABASE_URL = 'https://vgcbyctitojxzesmkvg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnY2J5Y3RpdGlvanh6ZXNta3ZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjQxMTgsImV4cCI6MjA4Njg0MDExOH0.ApLKumhJHL6KTjpvzzXMx2FSG2wGZuyA67yO-jTH-yk';

        let supabaseClient = null;

        function initSupabase() {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase conectado!');
                return true;
            } catch(e) {
                console.error('Erro Supabase:', e);
                return false;
            }
        }

        let currentPage = 'login';
        let currentUser = null;

        function openTermsModal() { document.getElementById('termsModal').classList.add('show'); }
        function closeTermsModal() {
            document.getElementById('termsModal').classList.remove('show');
            const cb = document.getElementById('termsCheckbox');
            if (cb) cb.checked = true;
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML.trim().substring(0, 100);
        }

        function validatePhone(phone) {
            const cleaned = phone.replace(/\D/g, '');
            return cleaned.length >= 10 && cleaned.length <= 11;
        }

        function showLoading() { document.getElementById('loading').classList.add('show'); }
        function hideLoading() { document.getElementById('loading').classList.remove('show'); }

        async function handleLogin() {
            if (!initSupabase()) {
                alert('‚ùå Erro ao conectar. Recarregue a p√°gina!');
                return;
            }

            const name = document.getElementById('nameInput')?.value?.trim();
            const phone = document.getElementById('phoneInput')?.value?.trim();
            const termsChecked = document.getElementById('termsCheckbox')?.checked;

            if (!name || name.length < 2) { alert('‚ùå Digite seu nome!'); return; }
            if (!phone) { alert('‚ùå Digite seu telefone!'); return; }
            if (!termsChecked) { alert('‚ùå Aceite os Termos de Uso!'); return; }
            if (!validatePhone(phone)) { alert('‚ùå Telefone inv√°lido! Use formato: 74999999999'); return; }

            showLoading();

            try {
                const cleanPhone = phone.replace(/\D/g, '');

                // VERIFICAR SE USU√ÅRIO J√Å EXISTE
                const { data: existingUser, error: searchError } = await supabaseClient
                    .from('users')
                    .select('id, nome, cidade')
                    .eq('telefone', cleanPhone)
                    .maybeSingle();

                let userId;

                if (existingUser) {
                    userId = existingUser.id;
                } else {
                    // CRIAR NOVO USU√ÅRIO
                    const { data: newUser, error: insertError } = await supabaseClient
                        .from('users')
                        .insert([{
                            nome: sanitizeInput(name),
                            telefone: cleanPhone,
                            cidade: 'JUAZEIRO',
                            termos_aceitos: true,
                            data_aceite_termos: new Date().toISOString(),
                            assinatura_ativa: false,
                            data_expiracao: '2026-04-01T23:59:59.000Z'
                        }])
                        .select('id')
                        .single();

                    if (insertError) {
                        console.error('Erro insert:', insertError);
                        throw new Error('Erro ao cadastrar: ' + insertError.message);
                    }
                    userId = newUser.id;
                }

                // GERAR C√ìDIGO
                const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();

                const { error: codeError } = await supabaseClient
                    .from('verification_codes')
                    .insert([{
                        user_id: userId,
                        code: verificationCode,
                        expires_at: new Date(Date.now() + 10 * 60000).toISOString(),
                        used: false
                    }]);

                if (codeError) {
                    console.error('Erro c√≥digo:', codeError);
                    throw new Error('Erro ao gerar c√≥digo: ' + codeError.message);
                }

                // ENVIAR WHATSAPP
                const message = `üõ°Ô∏è LIGA DO VALE\n\nOl√° ${name}! Seu c√≥digo de acesso:\n\nüîë ${verificationCode}\n\nDigite no site para liberar.\n‚ö†Ô∏è Expira em 10 minutos.\n\nN√£o compartilhe!`;
                window.open(`https://wa.me/55${cleanPhone}?text=${encodeURIComponent(message)}`, '_blank');

                sessionStorage.setItem('tempUserId', userId);
                sessionStorage.setItem('tempPhone', cleanPhone);
                sessionStorage.setItem('tempName', name);

                currentPage = 'verify';
                render();

            } catch (error) {
                console.error('Erro completo:', error);
                alert('‚ùå Erro: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function verifyCode() {
            if (!initSupabase()) { alert('‚ùå Erro de conex√£o!'); return; }

            const inputCode = document.getElementById('codeInput')?.value?.trim();
            const userId = sessionStorage.getItem('tempUserId');
            const name = sessionStorage.getItem('tempName');
            const phone = sessionStorage.getItem('tempPhone');

            if (!inputCode || inputCode.length !== 6) { alert('‚ùå Digite os 6 d√≠gitos!'); return; }

            showLoading();

            try {
                const { data: codeData, error } = await supabaseClient
                    .from('verification_codes')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('code', inputCode)
                    .eq('used', false)
                    .maybeSingle();

                if (error || !codeData) { alert('‚ùå C√≥digo inv√°lido!'); hideLoading(); return; }
                if (new Date(codeData.expires_at) < new Date()) { alert('‚ùå C√≥digo expirado!'); hideLoading(); return; }

                await supabaseClient.from('verification_codes').update({ used: true }).eq('id', codeData.id);

                const { data: userData } = await supabaseClient.from('users').select('*').eq('id', userId).single();
                currentUser = userData;

                sessionStorage.setItem('userId', userData.id);
                sessionStorage.removeItem('tempUserId');
                sessionStorage.removeItem('tempPhone');
                sessionStorage.removeItem('tempName');

                // BOAS VINDAS WHATSAPP
                const welcomeMsg = `üéâ BEM-VINDO(A) √Ä LIGA DO VALE! üåµ\n\nAgora voc√™ tem tudo na palma da m√£o:\n\nüíº Empregos novos todo dia\nüõí Ofertas dos supermercados\nüîß Encanadores e eletricistas\nü•≥ Agenda de festas\nüè™ Compra e venda com foto\nüíò Paquera local\n\nüîó Acesse: liga-do-vale.vercel.app\n\nüí° Adicione √† tela inicial do celular!\nüéÅ Teste gr√°tis at√© 1¬∫ de abril de 2026!`;
                setTimeout(() => window.open(`https://wa.me/55${phone}?text=${encodeURIComponent(welcomeMsg)}`, '_blank'), 1500);

                currentPage = 'home';
                render();

            } catch (error) {
                console.error('Erro verifica√ß√£o:', error);
                alert('‚ùå Erro: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function renderLogin() {
            return `
            <div class="min-h-screen bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4">üõ°Ô∏è</div>
                        <h1 class="text-3xl font-black text-green-600 mb-2">LIGA DO VALE</h1>
                        <p class="text-gray-600 text-sm">Sua cidade em um s√≥ lugar</p>
                    </div>
                    <div class="space-y-4">
                        <input id="nameInput" type="text" placeholder="Seu nome completo" maxlength="50"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-green-600 focus:outline-none text-gray-800"/>
                        <input id="phoneInput" type="tel" placeholder="74999999999 (s√≥ n√∫meros)"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-green-600 focus:outline-none text-gray-800"
                            oninput="this.value=this.value.replace(/[^0-9]/g,'')"/>
                        <div class="flex items-start space-x-3 bg-yellow-50 p-3 rounded-lg border-2 border-yellow-200">
                            <input id="termsCheckbox" type="checkbox" class="mt-1 w-5 h-5 cursor-pointer flex-shrink-0"/>
                            <label class="text-xs text-gray-700 cursor-pointer" onclick="document.getElementById('termsCheckbox').click()">
                                Li e concordo com os <a href="#" onclick="openTermsModal(); return false;" class="text-blue-600 underline font-bold">Termos de Uso</a> e entendo que meu WhatsApp ser√° usado para contatos.
                            </label>
                        </div>
                        <button onclick="handleLogin()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-lg text-lg transition-colors">
                            ENTRAR
                        </button>
                    </div>
                    <p class="text-center text-sm mt-6 font-bold text-green-600">üéÅ Teste GR√ÅTIS at√© 1¬∫ de abril de 2026!</p>
                </div>
            </div>`;
        }

        function renderVerify() {
            return `
            <div class="min-h-screen bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4">üì±</div>
                        <h2 class="text-2xl font-bold mb-2">Verifica√ß√£o WhatsApp</h2>
                        <p class="text-gray-500 text-sm">C√≥digo enviado para seu WhatsApp</p>
                        <p class="text-lg font-bold text-green-600 mt-1">${sessionStorage.getItem('tempPhone')}</p>
                    </div>
                    <div class="space-y-4">
                        <input id="codeInput" type="text" placeholder="000000" maxlength="6"
                            class="w-full px-4 py-5 border-2 border-gray-200 rounded-lg text-center text-4xl font-black tracking-widest focus:border-green-600 focus:outline-none"
                            oninput="this.value=this.value.replace(/[^0-9]/g,'')"/>
                        <button onclick="verifyCode()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-lg text-lg">
                            ‚úÖ VERIFICAR C√ìDIGO
                        </button>
                        <button onclick="currentPage='login';render()"
                            class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-lg text-sm">
                            üîÑ Voltar e tentar novamente
                        </button>
                    </div>
                    <p class="text-xs text-center text-gray-400 mt-4">‚è±Ô∏è C√≥digo expira em 10 minutos</p>
                </div>
            </div>`;
        }

        function renderHome() {
            const nome = currentUser?.nome || sessionStorage.getItem('tempName') || 'Usu√°rio';
            return `
            <div class="min-h-screen bg-gray-50">
                <div class="bg-gradient-to-r from-green-700 to-green-600 text-white p-4 shadow-lg">
                    <div class="flex items-center justify-between max-w-4xl mx-auto">
                        <div class="flex items-center gap-2">
                            <span class="text-3xl">üõ°Ô∏è</span>
                            <h1 class="text-xl font-black">LIGA DO VALE</h1>
                        </div>
                        <p class="text-sm font-bold opacity-90">${nome}</p>
                    </div>
                </div>
                <div class="max-w-4xl mx-auto p-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h2 class="text-3xl font-black text-green-700 mb-4">SISTEMA FUNCIONANDO!</h2>
                        <p class="text-gray-500 mb-6">Ol√° <strong>${nome}</strong>! Bem-vindo ao Liga do Vale!</p>
                        <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6 text-left">
                            <h3 class="font-black text-green-800 mb-4 text-lg">‚úÖ Tudo conectado:</h3>
                            <ul class="space-y-2 text-green-700 font-medium">
                                <li>‚úÖ Banco de dados (Supabase)</li>
                                <li>‚úÖ Autentica√ß√£o WhatsApp</li>
                                <li>‚úÖ Termos de uso</li>
                                <li>‚úÖ Seguran√ßa ativa</li>
                                <li>‚úÖ Hospedagem Vercel</li>
                            </ul>
                        </div>
                        <p class="mt-6 text-green-600 font-bold">üéÅ Teste gratuito at√© 1¬∫ de abril de 2026!</p>
                    </div>
                </div>
            </div>`;
        }

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            if (currentPage === 'login') app.innerHTML = renderLogin();
            else if (currentPage === 'verify') app.innerHTML = renderVerify();
            else if (currentPage === 'home') app.innerHTML = renderHome();
        }

        // INICIA QUANDO P√ÅGINA CARREGA
        window.addEventListener('load', () => {
            initSupabase();
            render();
        });
    </script>
</body>
</html>
