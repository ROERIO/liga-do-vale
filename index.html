<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIGA DO VALE - Sua cidade em um s√≥ lugar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f3f4f6; }
        .slide-in { animation: slideIn 0.3s ease-in; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; }
        .loading.show { display: flex; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 10px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="loading" class="loading"><div class="spinner"></div></div>
    
    <div id="termsModal" class="modal">
        <div class="modal-content slide-in">
            <h1 style="color: #16a34a; font-size: 26px; margin-bottom: 20px; font-weight: bold;">‚öñÔ∏è TERMOS DE USO E POL√çTICA DE PRIVACIDADE</h1>
            <h2 style="color: #333; font-size: 18px; margin-bottom: 20px;">LIGA DO VALE</h2>
            
            <div style="background: #fef3c7; padding: 15px; border-left: 4px solid #f59e0b; margin: 20px 0; border-radius: 5px;">
                <strong>‚ö†Ô∏è IMPORTANTE:</strong> Ao utilizar a LIGA DO VALE, voc√™ concorda com as seguintes regras:
            </div>

            <h2 style="color: #333; font-size: 18px; margin-top: 25px; margin-bottom: 12px;">1. O QUE N√ìS FAZEMOS</h2>
            <p style="color: #444; margin-bottom: 12px; line-height: 1.8;">A LIGA DO VALE √© uma plataforma de conex√£o hiperlocal. N√≥s facilitamos o acesso a informa√ß√µes (empregos, eventos, ofertas) e o contato entre pessoas. <strong>N√£o somos respons√°veis pelas negocia√ß√µes, pela qualidade dos servi√ßos prestados por terceiros ou pela veracidade total de an√∫ncios postados por usu√°rios.</strong></p>

            <h2 style="color: #333; font-size: 18px; margin-top: 25px; margin-bottom: 12px;">2. SEUS DADOS E PRIVACIDADE</h2>
            <p style="color: #444; margin-bottom: 12px; line-height: 1.8;">Para o sistema funcionar, coletamos seu <strong>Nome</strong> e <strong>N√∫mero de WhatsApp</strong>.</p>
            <p style="color: #444; margin-bottom: 12px; line-height: 1.8;"><strong>Visibilidade:</strong> Ao postar um an√∫ncio de venda, servi√ßo ou perfil de paquera, seu nome e telefone ficar√£o vis√≠veis para outros usu√°rios cadastrados, facilitando o contato direto.</p>
            <p style="color: #444; margin-bottom: 12px; line-height: 1.8;"><strong>Seguran√ßa:</strong> N√£o vendemos seus dados para empresas terceiras. Seus dados s√£o usados exclusivamente para o funcionamento do app.</p>

            <h2 style="color: #333; font-size: 18px; margin-top: 25px; margin-bottom: 12px;">3. REGRAS DE CONDUTA</h2>
            <p style="color: #444; margin-bottom: 12px; line-height: 1.8;">√â terminantemente proibido postar:</p>
            <ul style="margin-left: 25px; margin-bottom: 15px; line-height: 1.8;">
                <li style="color: #444; margin-bottom: 8px;">Conte√∫do ilegal, ofensivo, violento ou pornogr√°fico</li>
                <li style="color: #444; margin-bottom: 8px;">An√∫ncios falsos (golpes) ou produtos il√≠citos</li>
                <li style="color: #444; margin-bottom: 8px;">Ass√©dio ou desrespeito a outros usu√°rios</li>
            </ul>
            
            <div style="background: #fef3c7; padding: 15px; border-left: 4px solid #f59e0b; margin: 20px 0; border-radius: 5px;">
                <strong>‚ö†Ô∏è PUNI√á√ÉO:</strong> O descumprimento resultar√° no banimento imediato do n√∫mero de telefone, sem direito a reembolso de assinatura.
            </div>

            <h2 style="color: #333; font-size: 18px; margin-top: 25px; margin-bottom: 12px;">4. PAGAMENTOS E ASSINATURA</h2>
            <ul style="margin-left: 25px; margin-bottom: 15px; line-height: 1.8;">
                <li style="color: #444; margin-bottom: 8px;">A LIGA DO VALE oferece um <strong>per√≠odo de teste gratuito at√© 1¬∫ de abril de 2026</strong></li>
                <li style="color: #444; margin-bottom: 8px;">Ap√≥s esse per√≠odo, o acesso √© mediante assinatura:
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li style="color: #444; margin-bottom: 5px;"><strong>Plano Semanal:</strong> R$ 1,99/semana</li>
                        <li style="color: #444; margin-bottom: 5px;"><strong>Plano Mensal:</strong> R$ 4,99/m√™s</li>
                    </ul>
                </li>
            </ul>

            <h2 style="color: #333; font-size: 18px; margin-top: 25px; margin-bottom: 12px;">5. RESPONSABILIDADE NAS TRANSA√á√ïES</h2>
            <p style="color: #444; margin-bottom: 12px; line-height: 1.8;">A LIGA DO VALE <strong>n√£o processa o pagamento</strong> de produtos vendidos entre usu√°rios.</p>
            
            <div style="background: #fef3c7; padding: 15px; border-left: 4px solid #f59e0b; margin: 20px 0; border-radius: 5px;">
                <strong>üí° DICA:</strong> Nunca pague adiantado por algo que voc√™ n√£o viu pessoalmente.
            </div>

            <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">

            <p style="font-size: 13px; color: #666; text-align: center; margin-bottom: 20px;">
                <strong>LIGA DO VALE</strong> - Sua cidade em um s√≥ lugar<br>
                √öltima atualiza√ß√£o: 16 de fevereiro de 2026
            </p>

            <center>
                <button onclick="closeTermsModal()" style="background: #16a34a; color: white; padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">‚úÖ ENTENDI E ACEITO</button>
            </center>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vgcbyctitojxzesmkvg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnY2J5Y3RpdGlvanh6ZXNta3ZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjQxMTgsImV4cCI6MjA4Njg0MDExOH0.ApLKumhJHL6KTjpvzzXMx2FSG2wGZuyA67yO-jTH-yk';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentPage = 'login';
        let currentUser = null;
        let selectedCity = 'JUAZEIRO';

        function openTermsModal() { document.getElementById('termsModal').classList.add('show'); }
        function closeTermsModal() { 
            document.getElementById('termsModal').classList.remove('show');
            const checkbox = document.getElementById('termsCheckbox');
            if (checkbox) checkbox.checked = true;
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML.trim().substring(0, 100);
        }

        function validatePhone(phone) {
            const cleaned = phone.replace(/\D/g, '');
            return cleaned.length === 11 && !(/^0{11}$|^1{11}$/.test(cleaned));
        }

        function showLoading() { document.getElementById('loading').classList.add('show'); }
        function hideLoading() { document.getElementById('loading').classList.remove('show'); }
        function showError(message) { alert('‚ùå ' + message); }
        function showSuccess(message) { alert('‚úÖ ' + message); }

        async function handleLogin() {
            const name = document.getElementById('nameInput')?.value;
            const phone = document.getElementById('phoneInput')?.value;
            const termsChecked = document.getElementById('termsCheckbox')?.checked;

            if (!name || !phone) { showError('Preencha nome e telefone!'); return; }
            if (!termsChecked) { showError('Aceite os Termos de Uso!'); return; }
            if (!validatePhone(phone)) { showError('Telefone inv√°lido!'); return; }

            showLoading();

            try {
                const cleanPhone = phone.replace(/\D/g, '');
                
                let { data: existingUser } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('telefone', cleanPhone)
                    .single();

                let userId;

                if (existingUser) {
                    userId = existingUser.id;
                } else {
                    const { data: newUser, error } = await supabaseClient
                        .from('users')
                        .insert([{
                            nome: sanitizeInput(name),
                            telefone: cleanPhone,
                            cidade: selectedCity,
                            termos_aceitos: true,
                            data_aceite_termos: new Date().toISOString(),
                            assinatura_ativa: false,
                            data_expiracao: '2026-04-01'
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    userId = newUser.id;
                }

                const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
                
                await supabaseClient.from('verification_codes').insert([{
                    user_id: userId,
                    code: verificationCode,
                    expires_at: new Date(Date.now() + 10 * 60000).toISOString(),
                    used: false
                }]);

                const message = `üõ°Ô∏è LIGA DO VALE\n\nOl√° ${name}! Seu c√≥digo: ${verificationCode}\n\nDigite no site para liberar.\n‚ö†Ô∏è Expira em 10min.`;
                const waUrl = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(message)}`;
                window.open(waUrl, '_blank');

                sessionStorage.setItem('tempUserId', userId);
                sessionStorage.setItem('tempPhone', phone);
                sessionStorage.setItem('tempName', name);

                currentPage = 'verify';
                render();

            } catch (error) {
                console.error('Erro completo:', error);
                showError('Erro: ' + (error.message || 'Tente novamente'));
            } finally {
                hideLoading();
            }
        }

        async function verifyCode() {
            const inputCode = document.getElementById('codeInput')?.value;
            const userId = sessionStorage.getItem('tempUserId');
            const name = sessionStorage.getItem('tempName');
            const phone = sessionStorage.getItem('tempPhone');

            if (!inputCode || inputCode.length !== 6) { showError('Digite 6 d√≠gitos!'); return; }

            showLoading();

            try {
                const { data: codeData, error } = await supabaseClient
                    .from('verification_codes')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('code', inputCode)
                    .eq('used', false)
                    .single();

                if (error || !codeData) { showError('C√≥digo inv√°lido!'); hideLoading(); return; }
                if (new Date(codeData.expires_at) < new Date()) { showError('C√≥digo expirado!'); hideLoading(); return; }

                await supabaseClient.from('verification_codes').update({ used: true }).eq('id', codeData.id);

                const { data: userData } = await supabaseClient.from('users').select('*').eq('id', userId).single();

                currentUser = userData;
                sessionStorage.setItem('userId', userData.id);
                sessionStorage.removeItem('tempUserId');
                sessionStorage.removeItem('tempPhone');
                sessionStorage.removeItem('tempName');

                const welcomeMsg = `üéâ BEM-VINDO, ${name}! üåµ\n\nüíº Empregos\nüõí Ofertas\nüîß Profissionais\nü•≥ Festas\nüè™ Compra e venda\nüíò Paquera\n\nüéÅ Teste gr√°tis at√© 1¬∫ de abril!`;
                const welcomeUrl = `https://wa.me/55${phone.replace(/\D/g,'')}?text=${encodeURIComponent(welcomeMsg)}`;
                setTimeout(() => window.open(welcomeUrl, '_blank'), 1500);

                currentPage = 'home';
                showSuccess('Bem-vindo!');
                render();

            } catch (error) {
                console.error('Erro:', error);
                showError('Erro: ' + (error.message || 'Tente novamente'));
            } finally {
                hideLoading();
            }
        }

        function renderLogin() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-green-600 to-green-700 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üõ°Ô∏è</div>
                            <h1 class="text-3xl font-black text-green-600 mb-2">LIGA DO VALE</h1>
                            <p class="text-gray-600">Sua cidade em um s√≥ lugar</p>
                        </div>
                        <div class="space-y-4">
                            <input id="nameInput" type="text" placeholder="Seu nome" class="w-full px-4 py-3 border-2 rounded-lg focus:border-green-600">
                            <input id="phoneInput" type="tel" placeholder="(87) 99999-0000" class="w-full px-4 py-3 border-2 rounded-lg focus:border-green-600">
                            <div class="flex items-start space-x-2 bg-yellow-50 p-3 rounded-lg border-2 border-yellow-200">
                                <input id="termsCheckbox" type="checkbox" class="mt-1 w-5 h-5">
                                <label class="text-xs text-gray-700">
                                    Li e concordo com os <a href="#" onclick="openTermsModal(); return false;" class="text-blue-600 underline font-bold">Termos de Uso</a> e entendo que meu n√∫mero de WhatsApp ser√° usado para contatos.
                                </label>
                            </div>
                            <button onclick="handleLogin()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">ENTRAR</button>
                        </div>
                        <p class="text-center text-sm mt-4 font-bold text-green-600">üéÅ Teste GR√ÅTIS at√© 1¬∫ de abril de 2026!</p>
                    </div>
                </div>
            `;
        }

        function renderVerify() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-green-600 to-green-700 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üì±</div>
                            <h2 class="text-2xl font-bold mb-2">Verifica√ß√£o</h2>
                            <p class="text-gray-600">C√≥digo enviado para:</p>
                            <p class="text-lg font-bold text-green-600">${sessionStorage.getItem('tempPhone')}</p>
                        </div>
                        <div class="space-y-4">
                            <input id="codeInput" type="text" placeholder="000000" class="w-full px-4 py-4 border-2 rounded-lg text-center text-3xl font-bold tracking-widest" maxlength="6" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                            <button onclick="verifyCode()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">‚úÖ VERIFICAR</button>
                            <button onclick="currentPage='login';render()" class="w-full bg-gray-200 text-gray-700 font-bold py-2 rounded-lg text-sm">üîÑ Voltar</button>
                        </div>
                        <p class="text-xs text-center text-gray-500 mt-4">Expira em 10 minutos</p>
                    </div>
                </div>
            `;
        }

        function renderHome() {
            return `
                <div class="min-h-screen bg-gray-50">
                    <div class="bg-gradient-to-r from-green-600 to-green-700 text-white p-4 shadow-lg">
                        <div class="flex items-center justify-between max-w-4xl mx-auto">
                            <div class="flex items-center gap-2">
                                <span class="text-3xl">üõ°Ô∏è</span>
                                <h1 class="text-xl font-black">LIGA DO VALE</h1>
                            </div>
                            <div class="text-right text-sm">
                                <p class="font-bold">${currentUser?.nome || 'Usu√°rio'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="max-w-4xl mx-auto p-6 mt-10">
                        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                            <div class="text-6xl mb-4">‚úÖ</div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">SISTEMA FUNCIONANDO!</h2>
                            <p class="text-lg text-gray-600 mb-6">Conectado ao Supabase com sucesso!</p>
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6 text-left">
                                <h3 class="font-bold text-green-900 mb-3 text-lg">üéâ Tudo pronto:</h3>
                                <ul class="space-y-2 text-green-800">
                                    <li>‚úÖ Banco de dados conectado</li>
                                    <li>‚úÖ Autentica√ß√£o funcionando</li>
                                    <li>‚úÖ WhatsApp integrado</li>
                                    <li>‚úÖ Termos de uso configurados</li>
                                    <li>‚úÖ Seguran√ßa ativada (RLS)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            if (currentPage === 'login') app.innerHTML = renderLogin();
            else if (currentPage === 'verify') app.innerHTML = renderVerify();
            else if (currentPage === 'home') app.innerHTML = renderHome();
        }

        window.addEventListener('DOMContentLoaded', () => { render(); });
    </script>
</body>
</html>
